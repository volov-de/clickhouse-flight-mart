# üõ´ –ü—Ä–æ–µ–∫—Ç: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –ø–µ—Ä–µ–ª—ë—Ç–æ–≤ –≤ ClickHouse

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç SQL-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–π –≤–∏—Ç—Ä–∏–Ω—ã –∞–≤–∏–∞–ø–µ—Ä–µ–ª—ë—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ PostgreSQL –∏ JSON. –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ ClickHouse –∏ –≤–∫–ª—é—á–∞–µ—Ç ETL, –∞–≥—Ä–µ–≥–∞—Ü–∏—é, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

–ü—Ä–æ–µ–∫—Ç –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω–∂–µ–Ω–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏. –í—Å–µ –∑–∞–¥–∞—á–∏ —Ä–∞–∑–±–∏—Ç—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã.

### üî¢ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤

| ‚Ññ | –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|------|---------|
| 1 | `01_analysis_business_class_flights.sql` | –ê–Ω–∞–ª–∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å–∞ –ø–æ –º–µ—Å—è—Ü–∞–º |
| 2 | `02_count_delayed_passengers.sql` | –ü–æ–¥—Å—á—ë—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ >3 —á–∞—Å–æ–≤ |
| 3 | `03_setup_postgresql_replication.sql` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ PostgreSQL |
| 4 | `04_create_local_flights_table.sql` | –õ–æ–∫–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ–º |
| 5 | `05_create_airports_and_aggregates.sql` | –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞–º |
| 6 | `06_create_routes_materialized_view.sql` | –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ |
| 7 | `07_load_bookings_from_json.sql` | –ó–∞–≥—Ä—É–∑–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏–∑ JSON |
| 8 | `08_create_fct_flights_mart.sql` | –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ –ø–æ–ª—ë—Ç–æ–≤ |
| 9 | `09_create_weather_joined_mart.sql` | –í–∏—Ç—Ä–∏–Ω–∞ —Å –ø–æ–≥–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (ASOF JOIN) |
| 10| `10_optimize_performance.sql` | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| 11| `11_optimize_storage.sql` | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è: —Ç–∏–ø—ã, –∫–æ–¥–µ–∫–∏, Enum |

## üß∞ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **ClickHouse** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –°–£–ë–î
- **PostgreSQL** ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
- **JSON** ‚Äî —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **ETL** ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –∑–∞–≥—Ä—É–∑–∫–∞
- **ASOF JOIN** ‚Äî –Ω–µ—Ç–æ—á–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á

–ü—Ä–æ–µ–∫—Ç –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∞-–∏–Ω–∂–µ–Ω–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏. –ù–∏–∂–µ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –∑–∞–¥–∞—á–∏, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –∑–∞–¥–∞–Ω–∏–π:

### 1. –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–µ—Ä–∂–µ–∫ —Ä–µ–π—Å–æ–≤
> –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –º–µ—Å—è—Ü 2016 –≥–æ–¥–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—ã–ª–æ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–µ—Ä–µ–ª—ë—Ç–æ–≤ –±–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å–∞. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—ã–ª–µ—Ç–∞–º –∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á—ë—Ç –¥–ª—è –æ—Ç–¥–µ–ª–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

### 2. –ü–æ–¥—Å—á—ë—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤ —Å –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
> –ü–æ–¥—Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤, —á—å–∏ —Ä–µ–π—Å—ã –±—ã–ª–∏ –∑–∞–¥–µ—Ä–∂–∞–Ω—ã –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 3 —á–∞—Å–∞. –î–∞–Ω–Ω—ã–µ –Ω—É–∂–Ω—ã –¥–ª—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏.

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ PostgreSQL
> –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü—ã `flights` –∏–∑ –≤–Ω–µ—à–Ω–µ–π –±–∞–∑—ã PostgreSQL –≤ ClickHouse —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–≤–∏–∂–∫–∞ `PostgreSQL`. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É-–∏—Å—Ç–æ—á–Ω–∏–∫ `flights_remote`.

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ–º
> –°–æ–∑–¥–∞–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `flights` —Å –¥–≤–∏–∂–∫–æ–º `MergeTree`, –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ –º–µ—Å—è—Ü—É –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—ã–ª–µ—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤ –Ω–µ—ë –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.

### 5. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞–º
> –°–æ–∑–¥–∞–π—Ç–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É `flights_aggregates`, –≥–¥–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞ –≤—ã–ª–µ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ª–µ—Ç–æ–≤ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã—Ö —Ä–µ–π—Å–æ–≤.

### 6. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤
> –°–æ–∑–¥–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ `routes`, –∫–æ—Ç–æ—Ä–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö: –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞, –∞—ç—Ä–æ–ø–æ—Ä—Ç—ã –≤—ã–ª–µ—Ç–∞ –∏ –ø—Ä–∏–ª—ë—Ç–∞, –∫–æ–¥ —Å–∞–º–æ–ª—ë—Ç–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—ë—Ç–∞.

### 7. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
> –û—Ä–≥–∞–Ω–∏–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö –∏–∑ JSON. –î–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –±–∏–ª–µ—Ç—ã –∏ –ø–µ—Ä–µ–ª—ë—Ç—ã. –°–æ–∑–¥–∞–π—Ç–µ —Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

### 8. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–∏—Ç—Ä–∏–Ω—ã
> –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –µ–¥–∏–Ω—É—é –≤–∏—Ç—Ä–∏–Ω—É `fct_flights_mart`, –æ–±—ä–µ–¥–∏–Ω–∏–≤ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –±–∏–ª–µ—Ç—ã, —Ä–µ–π—Å—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.

### 9. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
> –†–∞—Å—à–∏—Ä—å—Ç–µ –≤–∏—Ç—Ä–∏–Ω—É, –¥–æ–±–∞–≤–∏–≤ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞—Ö –≤—ã–ª–µ—Ç–∞ –∏ –ø—Ä–∏–ª—ë—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ASOF JOIN` –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

### 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
> –£–ª—É—á—à–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å—á—ë—Ç:
> - –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –¥–∞—Ç–µ –≤—ã–ª–µ—Ç–∞
> - –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –ø–æ `flight_id`
> - —Å–∫–∏–ø-–∏–Ω–¥–µ–∫—Å–∞ –ø–æ –∞—ç—Ä–æ–ø–æ—Ä—Ç–∞–º

### 11. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
> –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –æ–±—ä—ë–º —Ö—Ä–∞–Ω–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
> - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `FixedString`, `LowCardinality`, `Enum`
> - –ø—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–∂–∞—Ç–∏–µ `Delta + ZSTD` –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
> - —Ä–∞–∑–ª–æ–∂–∏—Ç–µ `contact_data` –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω

## üß∞ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **ClickHouse** ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –°–£–ë–î
- **PostgreSQL** ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
- **JSON** ‚Äî —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **ETL** ‚Äî –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –∑–∞–≥—Ä—É–∑–∫–∞
- **–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- **ASOF JOIN** ‚Äî –Ω–µ—Ç–æ—á–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

–í –∏—Ç–æ–≥–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏—Ç—Ä–∏–Ω–∞ `fct_flights_weather_mart_opt`, –æ–±—ä—ë–º–æ–º –º–µ–Ω–µ–µ 555 –ú–ë, –ø—Ä–∏–≥–æ–¥–Ω–∞—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.